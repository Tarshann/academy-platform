# Academy Mobile App v1.3 — Agent Handoff Document

> Complete context for any AI agent building v1.3 of the Academy mobile app.
> Read this entirely before writing any code.

---

## Current State (v1.2.0, Build 16)

### What Ships Today

The app is a **React Native (Expo 54)** member companion for The Academy, a youth athletic training facility in Gallatin, Tennessee. It connects to the same tRPC backend as the web portal (`app.academytn.com`).

**Current version**: 1.2.0 (iOS build 16, submitted to App Store)
**Bundle ID**: `com.academytn.app`
**Package manager**: npm (NOT pnpm)

### Implemented Features

| Feature | Status | Quality |
|---------|--------|---------|
| **Authentication** (Clerk) | Complete | Email/password sign-in + sign-up with email verification |
| **Dashboard** | Complete | Welcome greeting, next session card, announcements feed, pull-to-refresh |
| **Schedule** | Complete | Upcoming sessions list, register for sessions, session type badges, capacity display |
| **Programs** | Complete | Browse programs from API, pricing display, category/sport labels, deep link to website for signup |
| **Group Chat** | Complete | Real-time via Ably, message history via REST, send messages, connection status indicator |
| **Direct Messages** | Complete | DM conversation list, unread counts/badges, real-time via Ably, start new conversations |
| **Profile** | Complete | User info, role badge, coach contact (call/text), sign out, account deletion, resource links |
| **Push Notifications** | Complete | Expo push token registration, notification tap deep linking (chat + DM), foreground display |
| **Analytics** | Complete | PostHog integration, screen tracking, event tracking (registrations, messages), user identity sync |
| **Error Handling** | Basic | ErrorBoundary component, config error screen for missing Clerk key |

### Architecture

```
academy-app/
├── app/
│   ├── _layout.tsx              # Root: Clerk → QueryClient → TRPCProvider → AuthGuard
│   ├── (auth)/
│   │   ├── sign-in.tsx          # Email/password sign in
│   │   └── sign-up.tsx          # Email/password sign up + email verification
│   ├── (tabs)/
│   │   ├── _layout.tsx          # 6-tab navigator: Dashboard, Chat, Messages, Schedule, Programs, Profile
│   │   ├── index.tsx            # Dashboard: welcome, next session, announcements
│   │   ├── chat.tsx             # Channel list (General, Coaches)
│   │   ├── messages.tsx         # DM conversation list + new conversation
│   │   ├── schedule.tsx         # Upcoming sessions + registration
│   │   ├── programs.tsx         # Program browser with pricing
│   │   └── profile.tsx          # User profile + settings + contacts
│   ├── chat/
│   │   ├── _layout.tsx          # Stack layout for chat rooms
│   │   └── [room].tsx           # Chat room: history, Ably real-time, send via REST
│   └── dm/
│       ├── _layout.tsx          # Stack layout for DM threads
│       └── [id].tsx             # DM conversation: messages, Ably real-time, mark read
├── components/
│   ├── ChatInput.tsx            # Text input + send button (multiline, 5000 char limit)
│   ├── ErrorBoundary.tsx        # React error boundary with retry
│   ├── Loading.tsx              # ActivityIndicator spinner
│   ├── MessageBubble.tsx        # Chat bubble (own vs other, sender name, images, timestamps)
│   └── Screen.tsx               # SafeAreaView wrapper
├── lib/
│   ├── analytics.ts             # PostHog: init, trackEvent, identifyUser, resetUser
│   ├── clerk.ts                 # Token cache using expo-secure-store
│   ├── device.ts                # Stable device ID via SecureStore
│   ├── notifications.ts         # Push registration, notification listeners, Android channel
│   ├── realtime.ts              # Ably client singleton, chat room + DM subscriptions
│   └── trpc.tsx                 # tRPC React client, httpBatchLink with Clerk JWT, 5-min stale time
└── assets/
    ├── icon.png                 # App icon
    ├── splash-icon.png          # Splash screen
    ├── adaptive-icon.png        # Android adaptive icon
    └── academy-logo.jpeg        # Logo used in sign-in/sign-up/dashboard
```

### Backend API Available (Not Yet Used by Mobile)

The tRPC backend at `app.academytn.com/api/trpc` exposes many routes the mobile app does NOT yet consume:

| API Route | Description | Mobile Status |
|-----------|-------------|---------------|
| `attendance.getMyAttendance` | User's attendance history | NOT USED |
| `attendance.getMyStats` | Attendance rate, totals | NOT USED |
| `shop.products` | Merchandise catalog | NOT USED |
| `shop.createCheckout` | Stripe checkout for merch | NOT USED |
| `payment.createCheckout` | Stripe checkout for programs | NOT USED |
| `payment.myPayments` | Payment history | NOT USED |
| `payment.mySubscriptions` | Active subscriptions | NOT USED |
| `gallery.list` / `gallery.byCategory` | Photo gallery | NOT USED |
| `videos.list` / `videos.byCategory` | Video content | NOT USED |
| `blog.list` / `blog.getBySlug` | Blog articles | NOT USED |
| `coaches.list` | Coach profiles with bios | NOT USED |
| `locations.list` | Training venues with addresses | NOT USED |
| `dm.searchMessages` | Full-text DM search | NOT USED |
| `dm.blockUser` / `unblockUser` | User blocking | NOT USED |
| `dm.muteConversation` / `unmute` | Mute notifications | NOT USED |
| `dm.archiveConversation` | Archive threads | NOT USED |
| `pushNotifications.getSettings` | Notification preferences | NOT USED |
| `pushNotifications.updateSettings` | Quiet hours, DM/channel toggles | NOT USED |
| `payment.submitPrivateSessionBooking` | Book 1-on-1 coaching | NOT USED |
| `contact.submit` | Contact form | NOT USED |

### Chat System Architecture

The chat system uses a hybrid approach:
- **Sending**: REST POST to `/api/chat/send` with a short-lived token from `auth.chatToken`
- **Receiving**: Ably real-time subscription on `chat:{room}` and `dm:{conversationId}` channels
- **History**: REST GET to `/api/chat/history/{room}` (returns last 50 messages)
- **Image upload**: REST POST to `/api/chat/upload-image` (S3, 5MB limit) — NOT implemented in mobile yet
- **@mentions**: Supported server-side but NOT implemented in mobile UI
- **Rooms**: `general`, `announcements`, `parents`, `coaches` (mobile only shows general + coaches)

### Design System

| Token | Value |
|-------|-------|
| Academy Gold | `#CFB87C` |
| Navy / Dark | `#1a1a2e` |
| Background | `#f5f5f5` |
| Card | `#fff` with shadow |
| Fonts | System (no custom fonts loaded) |
| Icons | `@expo/vector-icons` (Ionicons) |
| Radius | 12-16px for cards, 20px for inputs |

### Environment Variables

```
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY   # Clerk auth (required)
EXPO_PUBLIC_API_URL                 # Backend URL, e.g. https://app.academytn.com
EXPO_PUBLIC_POSTHOG_API_KEY         # PostHog analytics (optional, gracefully disabled)
EXPO_PUBLIC_PROJECT_ID              # Expo project ID for push notifications
```

### Known Issues / Tech Debt

1. **Profile shows "v1.1"** — hardcoded in `profile.tsx` footer, should be dynamic
2. **Chat rooms incomplete** — only General and Coaches are shown; Parents and Announcements rooms are available server-side but not exposed
3. **No image upload in chat** — server supports it, mobile doesn't
4. **No @mention support** — server supports it, mobile doesn't
5. **Programs link to website** — tapping a program opens `academytn.com/signup` instead of in-app enrollment
6. **No notification preferences UI** — tokens are registered but user can't configure quiet hours or toggle categories
7. **No attendance tracking** — API supports it, not shown in app
8. **New Architecture disabled** — `newArchEnabled: false` in app.json
9. **EAS Update channel not configured** — warning during build, OTA updates won't work
10. **No offline support** — app requires network for everything
11. **No skeleton loading screens** — just a spinner
12. **Coach contact hardcoded** — phone numbers in profile.tsx, not from API

---

## v1.3 Feature Roadmap — What Top Apps Do

### Tier 1: Core Experience (Must-Have)

#### 1. Onboarding Flow
- Animated walkthrough slides (3-4 screens) on first launch
- Permission requests (notifications, calendar) during onboarding
- Profile completion prompt (photo, emergency contact, sport interests)
- Skip option with persistent "complete your profile" nudge

#### 2. Enhanced Dashboard
- **Attendance stats card** — sessions attended, attendance rate, streak counter
- **Quick actions grid** — Book session, View schedule, Open chat, Contact coach
- **Upcoming payments** — next subscription renewal date/amount
- **Content feed** — latest blog posts, videos, gallery highlights
- **Weather widget** — for outdoor training awareness (optional)

#### 3. In-App Payments
- Program enrollment checkout (Stripe) without leaving the app
- Subscription management (view, cancel, upgrade)
- Payment history with receipt download
- Shop: browse merch, add to cart, checkout
- Order tracking with status updates

#### 4. Attendance Tracking
- View personal attendance history (calendar or list view)
- Attendance stats: total sessions, present rate, current streak
- QR code check-in at sessions (if supported)
- Attendance trend charts

#### 5. Notification Preferences
- Full settings screen with toggles:
  - DM notifications
  - Channel chat notifications
  - Announcement notifications
  - @mention notifications
  - Email fallback toggle
- Quiet hours (start/end time pickers)
- Per-conversation mute

### Tier 2: Engagement & Retention

#### 6. Content Hub
- **Gallery**: Grid view, categories (training, highlights), fullscreen lightbox, pinch-to-zoom
- **Videos**: Embedded TikTok/Instagram, category filters, view counts
- **Blog**: Article list with category filters, full article reader with rich text
- **Coaches**: Coach profiles with bio, specialties, certifications, photo

#### 7. Chat Enhancements
- All 4 rooms (add Parents + Announcements)
- Image upload from camera/gallery
- @mention with user autocomplete
- Message reactions (emoji)
- Typing indicators
- Link previews
- Read receipts in DMs
- Search messages
- Mute/archive conversations
- Block users

#### 8. Calendar Integration
- Native calendar sync for registered sessions
- Calendar view of schedule (month/week/day)
- Add to calendar button per session
- Reminders before sessions

#### 9. Location & Directions
- Training locations screen with map
- One-tap directions (Apple Maps / Google Maps)
- Location details with photos
- Geofence-based check-in (advanced)

### Tier 3: Delight & Differentiation

#### 10. Profile Enhancement
- Profile photo upload (Clerk or custom S3)
- Edit personal info
- Family member management (parent sees children's accounts)
- Achievement badges / progress milestones
- Dynamic version number (from app.json)

#### 11. Private Session Booking
- Browse available coaches
- View coach availability calendar
- Book 1-on-1 sessions in-app
- Session notes and preparation tips
- Post-session feedback

#### 12. Offline Support
- Cache dashboard data, schedule, conversations
- Queue messages for send when reconnected
- Graceful offline state UI

#### 13. Accessibility & Polish
- Dark mode support
- Dynamic font sizing
- VoiceOver / TalkBack support
- Haptic feedback on key interactions
- Skeleton loading screens (not spinners)
- Pull-to-refresh with animation
- Smooth page transitions (Reanimated)

#### 14. App Store Optimization
- App Store screenshots with device frames
- Video preview for listing
- Proper App Store description and keywords
- Rating prompt after positive interactions (StoreReview API)

---

## Technical Requirements for v1.3

### Dependencies to Add

```json
{
  "react-native-reanimated": "~3.x",
  "react-native-image-picker": "or expo-image-picker",
  "@shopify/flash-list": "for performant lists",
  "react-native-maps": "or expo-maps for location",
  "expo-calendar": "for calendar integration",
  "expo-store-review": "for app store rating prompts",
  "expo-haptics": "for haptic feedback",
  "react-native-mmkv": "or expo-file-system for offline cache",
  "@gorhom/bottom-sheet": "for native bottom sheets",
  "date-fns": "for date formatting",
  "expo-image": "for optimized image loading",
  "expo-av": "if adding video playback"
}
```

### Configuration Updates Needed

1. **app.json**: Bump `version` to `1.3.0`, increment `buildNumber`
2. **eas.json**: Add `channel` to build profiles for EAS Update support
3. **app.json plugins**: Add plugins for any new native modules (image picker, maps, etc.)
4. **Enable New Architecture**: Set `newArchEnabled: true` and test

### Build & Deploy

```bash
cd academy-app
npm install
npx expo start                          # Local dev
eas build --platform ios --profile production  # iOS production build
eas build --platform android --profile production  # Android production build
eas submit --platform ios              # Submit to App Store
eas submit --platform android          # Submit to Google Play
```

### Backend Readiness

The backend already supports every feature listed above. No backend changes are needed for v1.3. The mobile app simply needs to consume the existing API routes.

**Exception**: If you add features like coach availability calendar or QR check-in, those may need new backend endpoints.

---

## File-by-File Reference

### Root Layout (`app/_layout.tsx`)
- Initializes PostHog analytics
- Wraps app in Clerk → QueryClient → TRPCProvider
- AuthGuard redirects unauthenticated users to sign-in
- PushRegistration registers Expo push token on sign-in
- NotificationHandler deep links on notification tap
- ScreenTracker sends screen views to PostHog
- IdentitySync links Clerk user to PostHog

### Tab Layout (`app/(tabs)/_layout.tsx`)
- 6 tabs: Dashboard, Chat, Messages, Schedule, Programs, Profile
- Academy Gold active tab color
- Dark header (#1a1a2e)

### tRPC Client (`lib/trpc.tsx`)
- Imports `AppRouter` type from `../../server/routers`
- httpBatchLink with Clerk JWT in Authorization header
- 5-minute stale time, 2 retries
- API URL from `EXPO_PUBLIC_API_URL`

### Ably Realtime (`lib/realtime.ts`)
- Singleton client with token auth callback
- `subscribeToChatRoom(client, room, callback)` → `chat:{room}` channel
- `subscribeToDm(client, conversationId, callback)` → `dm:{id}` channel
- Manual close with `closeAbly()`

---

## Key Constraints

1. **Package manager is npm** — not pnpm, not yarn
2. **No shared UI code** with web portal or marketing site
3. **Styling is React Native StyleSheet** — not Tailwind, not NativeWind
4. **tRPC types come from `../../server/routers`** — path alias, not published package
5. **Auth is Clerk only** — no OAuth fallback on mobile
6. **Real-time is Ably** — not SSE (SSE is web portal only)
7. **Push is Expo Push** — uses expo-notifications, not Firebase directly
8. **iOS only currently** — Android support exists but no Google Play submission yet
9. **No CI/CD** — builds are manual via EAS CLI
10. **Versioning**: Bump `version` in app.json AND `buildNumber` for each submission
